<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCIC CORE | Control Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; color: #1e293b; }
        .view-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-item { transition: 0.2s; border-radius: 12px; cursor: pointer; color: #64748b; font-weight: 700; }
        .active-nav { background: #ea580c !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(234, 88, 12, 0.3); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl text-center">
            <h2 class="text-3xl font-black mb-6 italic">UCIC <span class="text-orange-600">ERP</span></h2>
            <input type="text" id="auth-user" placeholder="Usuario / Email" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-orange-500 font-bold text-center">
            <button onclick="handleLogin()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-orange-600 transition-all">ACCEDER</button>
        </div>
    </div>

    <nav class="w-72 bg-white border-r border-slate-200 flex flex-col p-6 space-y-8 z-40">
        <div>
            <h1 class="text-2xl font-black italic tracking-tighter">UCIC <span class="text-orange-600">CORE</span></h1>
            <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em]">v3.0 Office Sync</p>
        </div>
        <div class="space-y-2 flex-1 text-sm">
            <div onclick="switchView('dashboard')" id="nav-dashboard" class="sidebar-item p-4 flex items-center gap-3 active-nav"><i class="fa-solid fa-house"></i> Dashboard</div>
            <div onclick="switchView('academico')" id="nav-academico" class="sidebar-item p-4 flex items-center gap-3"><i class="fa-solid fa-user-graduate"></i> Acad√©mico</div>
            <div onclick="switchView('leads')" id="nav-leads" class="sidebar-item p-4 flex items-center gap-3"><i class="fa-solid fa-bolt"></i> Leads de n8n</div>
        </div>
        <div id="server-status" class="p-3 rounded-xl text-[9px] font-black uppercase text-center bg-red-100 text-red-600">
            Offline
        </div>
    </nav>

    <main class="flex-1 flex flex-col relative bg-slate-50">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-10">
            <h2 id="view-title" class="text-xl font-extrabold uppercase italic tracking-tight text-slate-800">Dashboard</h2>
            <button onclick="syncData()" class="bg-slate-900 text-white px-6 py-2 rounded-xl text-[10px] font-black hover:bg-orange-600 transition-all">
                <i class="fa-solid fa-rotate mr-2"></i> FORZAR SINCRONIZACI√ìN
            </button>
        </header>

        <section id="viewport" class="p-10 overflow-y-auto h-full">
            
            <div id="view-dashboard" class="view-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
                        <p class="text-slate-400 text-[10px] font-black uppercase">Alumnos Totales</p>
                        <h3 id="count-alumnos" class="text-5xl font-black mt-1">0</h3>
                    </div>
                    <div class="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
                        <p class="text-slate-400 text-[10px] font-black uppercase text-orange-600">Prospectos Pendientes</p>
                        <h3 id="count-leads" class="text-5xl font-black mt-1">0</h3>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
                    <canvas id="mainChart" height="100"></canvas>
                </div>
            </div>

            <div id="view-academico" class="view-content hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black italic">CONTROL ESCOLAR</h3>
                    <button onclick="abrirModalInscripcion()" class="bg-orange-600 text-white px-6 py-3 rounded-xl font-black text-xs">NUEVA INSCRIPCI√ìN</button>
                </div>
                <div class="bg-white rounded-[2rem] border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b text-[10px] font-black text-slate-400">
                            <tr><th class="p-6">ALUMNO</th><th class="p-6">CARRERA</th><th class="p-6 text-right">ACCI√ìN</th></tr>
                        </thead>
                        <tbody id="lista-alumnos" class="divide-y divide-slate-100 font-bold"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-leads" class="view-content hidden space-y-6">
                <h3 class="text-2xl font-black italic">LEADS RECIBIDOS DE N8N</h3>
                <div id="grid-leads" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

        </section>
    </main>

    <div id="modal-gestion" class="fixed inset-0 z-50 bg-slate-900/90 hidden backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-4xl rounded-[3rem] p-10 relative shadow-2xl overflow-y-auto max-h-[90vh]">
            <button onclick="cerrarModal()" class="absolute top-8 right-8 text-slate-400 hover:text-orange-600 text-3xl"><i class="fa-solid fa-circle-xmark"></i></button>
            <h3 id="nombre-gestion" class="text-4xl font-black italic mb-2">NOMBRE ALUMNO</h3>
            <p id="carrera-gestion" class="text-orange-600 font-black text-[10px] uppercase tracking-widest mb-8">CARRERA</p>
            
            <div id="horario-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10">
                </div>
            
            <div class="flex gap-4">
                <button onclick="generarKardexPDF()" class="flex-1 bg-slate-900 text-white p-5 rounded-2xl font-black text-xs hover:bg-blue-600 transition-all uppercase italic">
                    <i class="fa-solid fa-file-pdf mr-2"></i> Generar Kardex Oficial
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let db_alumnos = [];
        let db_leads = [];
        let indexActual = null;

        const MATERIAS = {
            "Cinematograf√≠a": ["Guionismo", "Cinefotograf√≠a", "Edici√≥n", "Producci√≥n"],
            "Software": ["Estructura de Datos", "Node.js", "Bases de Datos", "React"],
            "Derecho": ["Derecho Civil", "Derecho Penal", "Amparo", "Oratoria"]
        };

        // LOGIN
        function handleLogin() {
            document.getElementById('login-screen').classList.add('hidden');
            syncData();
            initChart();
            setInterval(syncData, 5000); // Sincroniza cada 5 seg solo
        }

        // SINCRONIZACI√ìN CON SERVIDOR
        async function syncData() {
            try {
                const res = await fetch(`${API_URL}/data`);
                const data = await res.json();
                db_alumnos = data.alumnos || [];
                db_leads = data.leads || [];
                
                const status = document.getElementById('server-status');
                status.className = "p-3 rounded-xl text-[9px] font-black uppercase text-center bg-green-100 text-green-600";
                status.innerText = "Servidor Online";
                
                renderAlumnos();
                renderLeads();
            } catch (e) {
                const status = document.getElementById('server-status');
                status.className = "p-3 rounded-xl text-[9px] font-black uppercase text-center bg-red-100 text-red-600";
                status.innerText = "Servidor Offline";
            }
        }

        function switchView(id) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active-nav'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.getElementById('nav-'+id).classList.add('active-nav');
            document.getElementById('view-title').innerText = id;
        }

        function renderAlumnos() {
            document.getElementById('count-alumnos').innerText = db_alumnos.length;
            const lista = document.getElementById('lista-alumnos');
            lista.innerHTML = db_alumnos.map((a, i) => `
                <tr class="hover:bg-slate-50">
                    <td class="p-6">${a.nombre.toUpperCase()} <br><span class="text-[9px] text-slate-400">ID: ${a.mat}</span></td>
                    <td class="p-6 text-orange-600 text-xs italic uppercase">${a.carrera}</td>
                    <td class="p-6 text-right"><button onclick="abrirGestion(${i})" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] uppercase">Gestionar</button></td>
                </tr>
            `).join('');
        }

        function renderLeads() {
            document.getElementById('count-leads').innerText = db_leads.length;
            const grid = document.getElementById('grid-leads');
            grid.innerHTML = db_leads.map((l, i) => `
                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm relative group">
                    <span class="absolute top-6 right-6 bg-orange-100 text-orange-600 text-[8px] font-black px-3 py-1 rounded-full italic uppercase">n8n Lead</span>
                    <h4 class="text-xl font-black mb-1">${l.nombre.toUpperCase()}</h4>
                    <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest">${l.carrera}</p>
                    <button onclick="convertirLead(${i})" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs hover:bg-orange-600 transition-all">CONVERTIR A ALUMNO</button>
                </div>
            `).join('');
        }

        async function convertirLead(i) {
            const lead = db_leads[i];
            const nuevoAlu = { nombre: lead.nombre, carrera: lead.carrera, mat: "UCIC-"+Math.floor(Math.random()*9000), horario: [] };
            
            await fetch(`${API_URL}/save-alumno`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoAlu)
            });
            alert("¬°Lead convertido con √©xito!");
            syncData();
        }

        function abrirGestion(i) {
            indexActual = i;
            const a = db_alumnos[i];
            document.getElementById('modal-gestion').classList.remove('hidden');
            document.getElementById('nombre-gestion').innerText = a.nombre;
            document.getElementById('carrera-gestion').innerText = a.carrera;
            
            const mats = MATERIAS[a.carrera] || ["Materia General 1", "Materia General 2"];
            document.getElementById('horario-container').innerHTML = mats.map(m => `
                <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-3 tracking-tighter">${m}</p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <select class="p-3 bg-white border rounded-xl text-[10px] font-bold outline-none"><option>LUN-MIE</option><option>MAR-JUE</option></select>
                        <select class="p-3 bg-white border rounded-xl text-[10px] font-bold outline-none"><option>07:00 - 09:00</option><option>18:00 - 20:00</option></select>
                    </div>
                    <select class="w-full p-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase"><option>üìç Presencial</option><option>üíª H√≠brido</option></select>
                </div>
            `).join('');
        }

        function cerrarModal() { document.getElementById('modal-gestion').classList.add('hidden'); }

        function generarKardexPDF() {
            const alu = db_alumnos[indexActual];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("helvetica", "bold");
            doc.text("UNIVERSIDAD UCIC - KARDEX OFICIAL", 105, 20, { align: "center" });
            doc.setFontSize(10);
            doc.text(`ALUMNO: ${alu.nombre.toUpperCase()}`, 20, 40);
            doc.text(`CARRERA: ${alu.carrera.toUpperCase()}`, 20, 50);
            doc.line(20, 60, 190, 60);
            doc.text("MATERIAS CURSANDO:", 20, 75);
            let y = 85;
            const mats = MATERIAS[alu.carrera] || [];
            mats.forEach(m => { doc.text(`‚Ä¢ ${m}`, 25, y); y+=10; });
            doc.save(`Kardex_${alu.nombre}.pdf`);
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: ['Oct', 'Nov', 'Dic'], datasets: [{ label: 'Ingresos', data: [30, 45, 90], borderColor: '#ea580c', tension: 0.4 }] },
                options: { plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>